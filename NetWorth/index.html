<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wealth Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
    integrity="sha512-yHfF2pEcM26E3ZByT1YBtv4k9ZcMWX4jzYq+rmM+5eT9tF0Ux6f8M6+MiwXxY7xR0PovcXZ6nXflW/4j6e7x0A==" 
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Custom CSS -->
  <style>
    /* Reset some defaults */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      colour: var(--text);
      transition: background 0.3s, colour 0.3s;
      padding: 20px;
    }
    /* Light and dark mode variables */
    body.light-mode {
      --bg: #ffffff;
      --text: #333333;
      --card-bg: #f9f9f9;
      --accent: #007bff;
    }
    body.dark-mode {
      --bg: #1e1e1e;
      --text: #dddddd;
      --card-bg: #2e2e2e;
      --accent: #66bfff;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    header h1 { font-size: 1.8em; }
    .toggle-mode {
      font-size: 1.5em;
      cursor: pointer;
    }
    /* Accounts container */
    #accounts-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .account-card {
      background: var(--card-bg);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      gap: 15px;
      align-items: flex-start;
    }
    .account-card img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
    }
    .account-details {
      flex: 1;
    }
    .account-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .account-header h2 {
      font-size: 1.3em;
    }
    /* Monthly table */
    .month-table {
      width: 100%;
      border-collapse: collapse;
    }
    .month-table th, .month-table td {
      padding: 5px 8px;
      text-align: left;
      border-bottom: 1px solid #ccc;
    }
    .editable {
      cursor: pointer;
    }
    /* Add new account button */
    #add-account-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 2em;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    /* Simple modal for adding/editing account */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
    }
    .modal-content h3 { margin-bottom: 10px; }
    .modal-content label { display: block; margin: 10px 0 5px; }
    .modal-content input[type="text"],
    .modal-content input[type="number"],
    .modal-content input[type="month"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .modal-content input[type="file"] {
      margin-top: 5px;
    }
    .modal-content button {
      margin-top: 15px;
      padding: 8px 12px;
      background: var(--accent);
      colour: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body class="light-mode">
  <header>
    <h1>Wealth Tracker</h1>
    <div class="toggle-mode" id="toggle-mode"><i class="fa-solid fa-moon"></i></div>
  </header>

  <div id="accounts-container">
    <!-- Accounts will be rendered here dynamically -->
  </div>

  <!-- Add new account button -->
  <button id="add-account-btn"><i class="fa-solid fa-plus"></i></button>

  <!-- Modal for adding/editing an account -->
  <div class="modal" id="account-modal">
    <div class="modal-content">
      <h3>Add / Edit Account</h3>
      <label for="account-name">Account/Investment Name</label>
      <input type="text" id="account-name" placeholder="Enter name">
      
      <label for="account-image">Upload Image</label>
      <input type="file" id="account-image" accept="image/*">
      
      <label for="account-month">Month (YYYY-MM)</label>
      <input type="month" id="account-month">
      
      <label for="account-amount">Amount (£)</label>
      <input type="number" id="account-amount" placeholder="Enter amount">
      
      <button id="save-account-btn">Save</button>
      <button id="cancel-account-btn" style="margin-left:10px;">Cancel</button>
    </div>
  </div>

  <!-- Include SortableJS via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js" 
    integrity="sha512-pbU+owmOmY0Ygsj3er+wuvTxpVbBjofOVMmaZxp3APwaEYEXj/fQJkfA3rMYcYLs+6e5O2coH62oix2D3/HQ7Q==" 
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  
  <!-- Main JavaScript -->
  <script>
    'use strict';
    // SeaTable configuration (please update endpoints as needed)
    const SEA_TABLE_URL = "https://cloud.seatable.io";
    const API_TOKEN = "b1646adafc4244fac0580404da72558222475f22";
    const BASE_NAME = "Tracker";
    const TABLE_NAME = "WealthTracker";

    // Dummy in-memory storage for demonstration – replace with actual SeaTable API calls
    let accounts = [];

    // Utility to format currency
    function formatCurrency(value) {
      return "£" + Number(value).toFixed(2);
    }

    // Calculate variance and percentage change
    function calculateVariance(prev, current) {
      let diff = current - prev;
      let percent = prev !== 0 ? (diff / prev * 100).toFixed(2) : '0.00';
      return { diff, percent };
    }

    // Render accounts in the container
    function renderAccounts() {
      const container = document.getElementById('accounts-container');
      container.innerHTML = '';
      accounts.forEach(account => {
        // Create account card element
        const card = document.createElement('div');
        card.className = 'account-card';
        card.dataset.id = account.id;

        // Account image
        const img = document.createElement('img');
        img.src = account.image || 'https://via.placeholder.com/60';
        card.appendChild(img);

        // Details container
        const details = document.createElement('div');
        details.className = 'account-details';
        // Header with name
        const header = document.createElement('div');
        header.className = 'account-header';
        const nameEl = document.createElement('h2');
        nameEl.textContent = account.name;
        header.appendChild(nameEl);
        details.appendChild(header);

        // Monthly data table
        const table = document.createElement('table');
        table.className = 'month-table';
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        ['Month', 'Amount', 'Change'].forEach(text => {
          const th = document.createElement('th');
          th.textContent = text;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);
        
        const tbody = document.createElement('tbody');
        // Sort months in ascending order
        let months = Object.keys(account.monthlyData).sort();
        months.forEach((month, idx) => {
          const tr = document.createElement('tr');
          const tdMonth = document.createElement('td');
          tdMonth.textContent = month;
          tr.appendChild(tdMonth);
          
          const tdAmount = document.createElement('td');
          tdAmount.textContent = formatCurrency(account.monthlyData[month]);
          tdAmount.classList.add('editable');
          tdAmount.dataset.month = month;
          // Allow inline editing on click
          tdAmount.addEventListener('click', () => {
            const newVal = prompt("Enter new amount for " + month, account.monthlyData[month]);
            if(newVal !== null) {
              const prevAmount = idx > 0 ? account.monthlyData[months[idx-1]] : 0;
              account.monthlyData[month] = parseFloat(newVal);
              // Save change to SeaTable (placeholder function)
              saveAccount(account);
              renderAccounts();
            }
          });
          tr.appendChild(tdAmount);

          const tdChange = document.createElement('td');
          if(idx > 0) {
            let prev = account.monthlyData[months[idx-1]];
            let curr = account.monthlyData[month];
            let { diff, percent } = calculateVariance(prev, curr);
            tdChange.textContent = formatCurrency(diff) + " (" + percent + "%)";
          } else {
            tdChange.textContent = "-";
          }
          tr.appendChild(tdChange);
          
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        details.appendChild(table);
        card.appendChild(details);
        container.appendChild(card);
      });
    }

    // Dummy function to simulate saving account to SeaTable
    function saveAccount(account) {
      // Here you would call fetch() to update the record in SeaTable
      // Example (adjust as per SeaTable API docs):
      /*
      fetch(SEA_TABLE_URL + "/dtable-server/api/v1/dtables/" + BASE_NAME + "/data/", {
        method: 'POST',
        headers: {
          'Authorization': 'Token ' + API_TOKEN,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          table_name: TABLE_NAME,
          record: account
        })
      }).then(response => response.json()).then(data => {
        console.log("Saved", data);
      });
      */
      console.log("Saving account:", account);
      // For demo, simply update the in-memory array.
      const index = accounts.findIndex(a => a.id === account.id);
      if(index > -1) accounts[index] = account;
    }

    // Dummy function to simulate loading accounts from SeaTable
    function loadAccounts() {
      // Here you would call fetch() to retrieve data from SeaTable
      // For demo purposes, we initialize with sample data.
      accounts = [
        {
          id: '1',
          name: 'Main Bank Account',
          image: 'https://via.placeholder.com/60/007bff/ffffff?text=B',
          monthlyData: {
            "2025-01": 5000,
            "2025-02": 5200,
            "2025-03": 5100
          }
        },
        {
          id: '2',
          name: 'Investments',
          image: 'https://via.placeholder.com/60/28a745/ffffff?text=I',
          monthlyData: {
            "2025-01": 15000,
            "2025-02": 15200,
            "2025-03": 15500
          }
        }
      ];
      renderAccounts();
    }

    // Toggle light/dark mode
    document.getElementById('toggle-mode').addEventListener('click', () => {
      const body = document.body;
      if(body.classList.contains('light-mode')) {
        body.classList.remove('light-mode');
        body.classList.add('dark-mode');
        document.getElementById('toggle-mode').innerHTML = '<i class="fa-solid fa-sun"></i>';
      } else {
        body.classList.remove('dark-mode');
        body.classList.add('light-mode');
        document.getElementById('toggle-mode').innerHTML = '<i class="fa-solid fa-moon"></i>';
      }
    });

    // Modal logic for adding a new account entry (or new month data)
    const accountModal = document.getElementById('account-modal');
    const addAccountBtn = document.getElementById('add-account-btn');
    let editingAccountId = null; // if editing an existing account

    addAccountBtn.addEventListener('click', () => {
      // Clear modal fields
      document.getElementById('account-name').value = "";
      document.getElementById('account-image').value = "";
      document.getElementById('account-month').value = "";
      document.getElementById('account-amount').value = "";
      editingAccountId = null;
      accountModal.style.display = "flex";
    });
    document.getElementById('cancel-account-btn').addEventListener('click', () => {
      accountModal.style.display = "none";
    });
    document.getElementById('save-account-btn').addEventListener('click', () => {
      const name = document.getElementById('account-name').value.trim();
      const month = document.getElementById('account-month').value;
      const amount = parseFloat(document.getElementById('account-amount').value);
      const imageFile = document.getElementById('account-image').files[0];

      if (!name || !month || isNaN(amount)) {
        alert("Please fill in all fields.");
        return;
      }

      // Convert image file to base64 if provided
      if(imageFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const imageData = e.target.result;
          processAccount(name, month, amount, imageData);
        }
        reader.readAsDataURL(imageFile);
      } else {
        processAccount(name, month, amount, "");
      }
    });

    function processAccount(name, month, amount, imageData) {
      if(editingAccountId) {
        // Find existing account and update
        const account = accounts.find(a => a.id === editingAccountId);
        if(account) {
          account.name = name;
          if(imageData) account.image = imageData;
          account.monthlyData[month] = amount;
          saveAccount(account);
        }
      } else {
        // Create new account record
        const newAccount = {
          id: Date.now().toString(),
          name: name,
          image: imageData || '',
          monthlyData: {}
        };
        newAccount.monthlyData[month] = amount;
        accounts.push(newAccount);
        // Here you would call the SeaTable API to insert the record.
        console.log("New account added:", newAccount);
      }
      accountModal.style.display = "none";
      renderAccounts();
    }

    // Initialise drag and drop ordering using SortableJS
    new Sortable(document.getElementById('accounts-container'), {
      animation: 150,
      onEnd: function (evt) {
        // When an account is dragged and dropped, update the accounts array order accordingly.
        const movedItem = accounts.splice(evt.oldIndex, 1)[0];
        accounts.splice(evt.newIndex, 0, movedItem);
        console.log("Accounts reordered", accounts);
        // Optionally, save the new order to SeaTable.
      }
    });

    // Load accounts on page load
    window.onload = loadAccounts;
  </script>
</body>
</html>
